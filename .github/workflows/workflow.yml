name: "WORKFLOW.YML"

on: [push, pull_request]

jobs:
  file_existence:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
          - os: windows-latest
          - os: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v1

      - name: Check file existence
        id: check_files
        uses: andstor/file-existence-action@v1
        with:
          files: "test_git.txt"

      - name: File not exist
        if: steps.check_files.outputs.files_exists == 'false'
        run: |
            echo File does not exist!
            stopMarker=$(uuidgen)
            echo "::stop-commands::$stopMarker"
            echo "::$stopMarker::"
        
      - name: File exists
        if: steps.check_files.outputs.files_exists == 'true'
        run: echo File exists, ready for !
        
      - uses: actions/checkout@v2 
      - name: DoxygenDocumentationCreate
        uses: mattnotmitt/doxygen-action@edge
        with:
          working-directory: './'
          doxyfile-path: './Doxyfile'
          
      - name: upload result
        uses: actions/upload-artifact@v3
        with:
          path: doc
          name: Doxygen
          
      - name: Push to IO repository
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source-directory: './doc'
          destination-github-username: 'UnkoolNobody'
          destination-repository-name: 'SimpleChatter.io'
          user-email: 'michaelzh2002@mail.ru'
          commit-message: 'Doxygen-documentation'
          target-branch: main

      - name: Build for Linux
        if: matrix.os == 'ubuntu-latest'
        run: g++ -fPIC -lm -shared src/stats.c -o dist/sqlite3-stats.so

      - name: Build for Windows
        if: matrix.os == 'windows-latest'
        run: g++ -fPIC -lm -shared src/stats.c -o dist/sqlite3-stats.dll

      - name: Build for macOS
        if: matrix.os == 'macos-latest'
        run: g++ -fno-common -dynamiclib src/stats.c -o dist/sqlite3-stats.dylib
        
      - name: upload prog
        uses: actions/upload-artifact@v3
        with:
          path: prog
          name: Compiled Program
